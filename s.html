<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>STERLA - ALL FEATURES FIXED</title>
<style>
:root{
--black:#0b0b0d; --card:#111216; --light-blue:#84d2ff; --light-purple:#c2b3ff;
--muted:#9aa0b4; --white:#ffffff; --success:#3cd48b; --danger:#e55a5a;
}
*{box-sizing:border-box;font-family:Inter,Poppins,sans-serif;}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#0b0b0d 0%,#0f1724 100%);color:var(--white);}
#loginPage{height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
.login-card{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));padding:28px;border-radius:20px;width:360px;box-shadow:0 12px 40px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03);}
.login-card h2{margin-bottom:8px;color:var(--light-purple)}
.login-card p{color:var(--muted);margin-bottom:16px}
.input{width:100%;padding:12px;border-radius:12px;border:none;margin:8px 0;background:rgba(255,255,255,0.03);color:var(--white);outline:none}
.btn{width:100%;padding:12px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--light-blue),var(--light-purple));color:#001;cursor:pointer;font-weight:700}
.small-btn{padding:8px 12px;border-radius:10px;border:none;background:transparent;color:var(--light-blue);cursor:pointer}
#appPage{display:none;height:100vh;display:flex;overflow:hidden}
#sidebar{width:260px;background:linear-gradient(180deg,#071028,#0b1633);padding:28px;color:var(--white);border-right:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:14px}
.brand{font-size:28px;font-weight:800;color:var(--light-purple);letter-spacing:1px}
.nav-btn{background:transparent;border:none;color:var(--muted);padding:12px 14px;text-align:left;border-radius:10px;cursor:pointer;font-weight:700}
.nav-btn.active, .nav-btn:hover{background:rgba(255,255,255,0.02);color:var(--white);box-shadow:0 6px 20px rgba(124,107,255,0.08)}
#main{flex:1;overflow:auto;padding:30px;background:linear-gradient(180deg,#0b0f1a 0%,#0b1220 30%)}
#welcomeBox{background:linear-gradient(180deg,#071028,#0b1430);border-radius:16px;padding:26px;color:var(--white);display:flex;justify-content:space-between;align-items:center;gap:20px}
#welcomeBox h2{color:var(--light-blue);font-size:22px;margin:0}
#welcomeBox p{margin:0;color:var(--muted)}
.subject-grid{margin-top:18px;display:flex;flex-wrap:wrap;gap:18px}
.subject-card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:20px;border-radius:14px;width:200px;cursor:pointer;box-shadow:0 10px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.02);font-weight:800;color:var(--light-blue);text-align:center}
.subject-card:hover{transform:translateY(-6px);box-shadow:0 18px 50px rgba(6,10,40,0.8)}
.page{display:none}
.page.active{display:block}
.output-box{background:linear-gradient(180deg,#061022,#081428);padding:18px;border-radius:14px;border:1px solid rgba(255,255,255,0.02);color:var(--white)}
.flow-controls{display:flex;gap:12px;align-items:center;margin-bottom:20px;flex-wrap:wrap}
.flow-controls select,.flow-controls button{padding:10px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.03);color:var(--white);font-weight:600}
.flow-controls button{background:linear-gradient(90deg,var(--light-blue),var(--light-purple));border:none;cursor:pointer}
.flow-controls button:hover,.flow-controls button:active{transform:translateY(-2px)}
.flow-node{fill:#071f35;stroke:var(--light-blue);stroke-width:3px;rx:12;ry:12;cursor:pointer;transition:all 0.3s}
.flow-node:hover{fill:#0a2a4a;stroke:var(--light-purple);stroke-width:4px;transform:translateY(-2px)}
.flow-text{fill:var(--white);font-family:Inter,sans-serif;font-weight:600;font-size:14px;text-anchor:middle;pointer-events:none}
.flow-line{stroke:var(--light-purple);stroke-width:3px;stroke-linecap:round;fill:none;filter:drop-shadow(0 2px 4px rgba(132,210,255,0.3))}
.quiz-btn{margin:8px;padding:12px 20px;border-radius:8px;border:1px solid var(--light-blue);background:transparent;color:var(--light-blue);cursor:pointer;font-weight:600}
.quiz-btn:hover{background:var(--light-blue);color:#001}
.quiz-btn.correct{background:var(--success);color:#000}
.quiz-btn.wrong{background:var(--danger);color:#fff}
#chatBox{background:#061025;padding:12px;border-radius:12px;min-height:360px;max-height:520px;overflow:auto;border:1px solid rgba(255,255,255,0.02)}
.chat-input{margin-top:12px;display:flex;gap:12px}
.chat-input input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff}
.chat-input button{padding:10px 16px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--light-blue),var(--light-purple));color:#001;font-weight:800}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:26px;padding:10px 18px;border-radius:999px;font-weight:700;z-index:1000}
.toast.success{background:var(--success);color:#000}
.toast.error{background:var(--danger);color:#fff}
@media (max-width:900px){#sidebar{display:none}#main{padding:18px}}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage">
<div class="login-card">
<h2>STERLA</h2>
<p>Select your role to continue</p>
<select id="roleSelect" class="input">
<option value="">Choose role</option>
<option value="Student">Student</option>
<option value="Teacher">Teacher</option>
</select>
<button class="btn" onclick="onLogin()">Login</button>
<p id="loginMessage" style="color:var(--danger);min-height:18px"></p>
<div style="margin-top:10px;display:flex;gap:8px;justify-content:center">
<button class="small-btn" onclick="onLogin(true)">Continue as Guest</button>
</div>
</div>
</div>

<!-- APP -->
<div id="appPage">
<aside id="sidebar">
<div class="brand">STERLA</div>
<button class="nav-btn active" data-page="homePage" onclick="navigate(event)">Home</button>
<button class="nav-btn" data-page="subjectsPage" onclick="navigate(event)">Subjects</button>
<button class="nav-btn" data-page="topicPage" onclick="navigate(event)">Topics</button>
<button class="nav-btn" data-page="mindmapPage" onclick="navigate(event)">Flowchart</button>
<button class="nav-btn" data-page="quizPage" onclick="navigate(event)">Quiz</button>
<button class="nav-btn" data-page="wsPage" onclick="navigate(event)">Worksheet</button>
<button class="nav-btn" data-page="aiChatPage" onclick="navigate(event)">AI Chat</button>
<div style="flex:1"></div>
</aside>

<main id="main">
<section id="homePage" class="page active">
<div id="welcomeBox">
<div>
<h2>Welcome to STERLA</h2>
<p>Your learning companion</p>
</div>
<div style="text-align:right;color:var(--muted)">
<div id="welcomeUser">Guest</div>
</div>
</div>
<h3 style="color:var(--light-blue);margin-top:8px">Quick Subjects</h3>
<div class="subject-grid" id="subjectsQuick"></div>
</section>

<section id="subjectsPage" class="page">
<h3>Subjects</h3>
<div class="subject-grid" id="subjectsList"></div>
</section>

<section id="topicPage" class="page">
<h3>Topics</h3>
<div class="subject-grid" id="topicsList"></div>
</section>

<!-- FLOWCHART - FULLY FIXED -->
<section id="mindmapPage" class="page">
<h3>Flowchart Generator</h3>
<div class="flow-controls">
<label style="color:var(--light-blue);font-weight:600;margin-right:8px;">Select Topic:</label>
<select id="flowTopicSelect">
<option value="">Choose a subject first...</option>
</select>
<button onclick="generateFlowchart()">Generate Flowchart</button>
</div>
<div id="flowchartStatus" style="color:var(--light-purple);margin-bottom:15px;font-weight:600"></div>
<div id="flowchartContainer" style="background:linear-gradient(180deg,#071427,#02101a);border-radius:14px;padding:20px;min-height:500px;overflow:auto;border:1px solid rgba(255,255,255,0.03);">
<svg id="flowSvg" width="100%" height="500"></svg>
</div>
</section>

<!-- QUIZ -->
<section id="quizPage" class="page">
<h3>Quiz</h3>
<div id="quizStatus" style="color:var(--light-purple);margin-bottom:15px;font-weight:600"></div>
<div id="quizOutput" class="output-box" style="min-height:300px"></div>
<button class="btn" onclick="loadQuiz()" style="margin-top:20px;width:200px">Reload Quiz</button>
</section>

<!-- WORKSHEET -->
<section id="wsPage" class="page">
<h3>Worksheet</h3>
<div id="wsStatus" style="color:var(--light-purple);margin-bottom:15px;font-weight:600"></div>
<div id="wsOutput" class="output-box" style="min-height:300px"></div>
<button class="btn" onclick="loadWorksheet()" style="margin-top:20px;width:200px">Reload Worksheet</button>
</section>

<section id="aiChatPage" class="page">
<h3>AI Chat</h3>
<div id="chatBox"></div>
<div class="chat-input">
<input type="text" id="chatInput" placeholder="Ask a question..." />
<button onclick="sendMessage()">Send</button>
</div>
</section>
</main>
</div>

<script>
// GLOBAL STATE
let userName = 'Guest', userRole = 'Guest';
let selectedSubject = null, chosenTopic = null;

// SUBJECTS
const subjects = ["Grammar","Algebra","HTML","Electricity","Formal Letter","Speech","Prose","Linear Equations","Mensuration","Sound"];
const subjectTopics = {
"English":["Grammar","Formal Letter","Speech","Prose"],
"Math":["Algebra","Linear Equations","Mensuration"],
"Science":["Reproduction in Animals","Sound","Electricity"],
"Social Science":["1857 Revolt","Resources","Judiciary"],
"Hindi":["Vyakaran","Patra Lekhan"],
"Computer":["HTML","AI Basics"],
"Sanskrit":["Shabd Roop","Dhatu Roop"],
"French":["French Grammar","Culture"],
"ICT":["Networks","Cybersecurity"]
};

// FLOWCHART DATA - COMPLETE
const flowchartBank = {
"Grammar":["Parts of Speech","Sentence Structure","Tenses","Punctuation","Usage Rules"],
"Formal Letter":["Sender Address","Date","Receiver Address","Subject","Salutation","Body Paragraphs","Closing"],
"Speech":["Introduction","Body Points","Conclusion","Eye Contact","Gestures","Voice Modulation"],
"Prose":["Paragraphs","Characters","Storyline","Dialogue","Narrative Flow"],
"Algebra":["Expressions","Equations","Formulas","Solve for Unknowns","Linear & Quadratic"],
"Linear Equations":["Variables","Equation Form","Graph Representation","Substitution","Elimination"],
"Mensuration":["Area","Perimeter","Volume","Surface Area","Formulas"],
"Reproduction in Animals":["Sexual Reproduction","Asexual Reproduction","Human Systems","Fertilization","Development"],
"Sound":["Vibration","Pitch","Amplitude","Frequency","Reflection"],
"Electricity":["Electric Charge","Ohm's Law","Circuits","Series & Parallel","Safety Devices"],
"1857 Revolt":["Causes","Key Leaders","Events","Outcome","Lessons Learned"],
"Resources":["Renewable","Non-renewable","Conservation","Sustainability","Examples"],
"Judiciary":["Supreme Court","High Court","Lower Courts","Judges","Rights Protection"],
"Vyakaran":["Sandhi","Samas","Ling","Vachya","Tense & Vachan"],
"Patra Lekhan":["Formal Letter","Informal Letter","Sender & Receiver","Salutation","Closing"],
"HTML":["Tags","Attributes","Headings","Paragraphs","Links & Images"],
"AI Basics":["Narrow AI","General AI","Applications","Data & Algorithms","Automation"],
"Shabd Roop":["Singular/Plural","Gender Changes","Case Forms","Usage","Verb Forms"],
"Dhatu Roop":["Root Verb Forms","Tenses","Sentence Construction","Examples","Practice"],
"French Grammar":["Articles","Nouns","Adjectives","Verbs","Tenses"],
"Culture":["Festivals","Food","Music","Lifestyle","Etiquette"],
"Networks":["LAN","WAN","Topology","Devices","Protocols"],
"Cybersecurity":["Threats","Firewall","Antivirus","Safe Practices","Case Studies"]
};


// QUIZ BANK
"Grammar":[
{ q:"Which of the following is a noun?", options:["run","dog","quickly","beautiful"], answer:"dog" },
{ q:"Identify the verb in the sentence.", options:["is","happy","table","red"], answer:"is" },
{ q:"What is an adjective?", options:["A describing word","A doing word","A place","A person"], answer:"A describing word" }
],
"Formal Letter":[
{q:"Which salutation is correct?", options:["Dear Sir","Hi buddy","Hey","Yo"], answer:"Dear Sir"},
{q:"Where does the date appear?", options:["Top right","Bottom left","Middle","Nowhere"], answer:"Top right"}
],
"Speech":[
{q:"Opening of speech should be?", options:["Attention grabber","Random word","Slang","Silent start"], answer:"Attention grabber"},
{q:"How to conclude speech?", options:["Summarize & end memorably","Stop abruptly","Say random joke","Ignore"], answer:"Summarize & end memorably"}
],
"Prose":[
{q:"Prose is written in?", options:["Ordinary grammatical structure","Verse form","Poetry","Haiku"], answer:"Ordinary grammatical structure"},
{q:"Does prose contain verses?", options:["No","Yes","Sometimes","Only poems"], answer:"No"}
],
"Algebra":[
{q:"Solve x + 5 = 12", options:["x=7","x=17","x=5","x=12"], answer:"x=7"},
{q:"Simplify 2x + 3x", options:["5x","6x","x","2x"], answer:"5x"}
],
"Linear Equations":[
{q:"Solve 2x + 3 = 7", options:["x=2","x=5","x=3","x=1"], answer:"x=2"},
{q:"Equation y = 2x + 1 forms?", options:["Straight line","Curve","Circle","Random"], answer:"Straight line"}
],
"Mensuration":[
{q:"Find area of rectangle 5x7 cm?", options:["35","12","57","None"], answer:"35"},
{q:"Volume of cube side 4cm?", options:["64","16","12","8"], answer:"64"}
],
"Reproduction in Animals":[
{q:"Two types of reproduction?", options:["Sexual & Asexual","Only sexual","Only asexual","None"], answer:"Sexual & Asexual"},
{q:"Fertilization occurs in?", options:["Animals & plants","Only animals","Only plants","None"], answer:"Animals & plants"}
],
"Sound":[
{q:"Sound is?", options:["Vibration","Color","Light","Force"], answer:"Vibration"},
{q:"Speed of sound depends on?", options:["Medium","Color","Shape","Time"], answer:"Medium"}
],
"Electricity":[
{q:"Ohm's law formula?", options:["V=IR","V+IR","VI=R","None"], answer:"V=IR"},
{q:"Series circuit has?", options:["Same current","Same voltage","Both","None"], answer:"Same current"}
],
"1857 Revolt":[
{q:"First War of Independence year?", options:["1857","1757","1947","1800"], answer:"1857"},
{q:"Leader of revolt?", options:["Mangal Pandey","Nehru","Gandhi","Tipu Sultan"], answer:"Mangal Pandey"}
],
"Resources":[
{q:"Renewable resource example?", options:["Solar energy","Coal","Oil","Gas"], answer:"Solar energy"},
{q:"Non-renewable resource?", options:["Coal","Sunlight","Wind","Water"], answer:"Coal"}
],
"Judiciary":[
{q:"Highest court in India?", options:["Supreme Court","High Court","District Court","None"], answer:"Supreme Court"},
{q:"Independent judiciary protects?", options:["Rights","Money","Food","Vehicles"], answer:"Rights"}
],
"Vyakaran":[
{q:"Sandhi is?", options:["Joining of words","Verb","Noun","Adjective"], answer:"Joining of words"},
{q:"Correct gender usage?", options:["Masculine/Feminine","Singular only","Plural only","None"], answer:"Masculine/Feminine"}
],
"Patra Lekhan":[
{q:"Formal letter closing?", options:["Yours sincerely","Bye","Cheers","Later"], answer:"Yours sincerely"},
{q:"Should slang be used?", options:["No","Yes","Sometimes","Optional"], answer:"No"}
],
"HTML":[
{q:"HTML stands for?", options:["HyperText Markup Language","HighText Modern Language","Hyper Tool Markup Language","None"], answer:"HyperText Markup Language"},
{q:"Tag for paragraph?", options:["<p>","<h1>","<img>","<a>"], answer:"<p>"}
],
"AI Basics":[
{q:"AI stands for?", options:["Artificial Intelligence","Automated Input","Artificial Interface","None"], answer:"Artificial Intelligence"},
{q:"Narrow AI example?", options:["Chatbot","Self-driving car","Human brain","All"], answer:"Chatbot"}
],
"Shabd Roop":[
{q:"Shabd Roop studies?", options:["Word forms","Colors","Animals","Numbers"], answer:"Word forms"},
{q:"Helps in?", options:["Sentence formation","Cooking","Music","Painting"], answer:"Sentence formation"}
],
"Dhatu Roop":[
{q:"Dhatu Roop is about?", options:["Verb roots","Nouns","Adjectives","Adverbs"], answer:"Verb roots"},
{q:"Used for?", options:["Sentence construction","Painting","Drawing","Music"], answer:"Sentence construction"}
],
"French Grammar":[
{q:"French grammar includes?", options:["Articles, nouns, verbs","Colors","Music","Dance"], answer:"Articles, nouns, verbs"},
{q:"Tense example?", options:["Present","Past","Future","All"], answer:"All"}
],
"Culture":[
{q:"French culture includes?", options:["Traditions, food, art","Cars","Technology","Animals"], answer:"Traditions, food, art"},
{q:"Helps in?", options:["Communication","Sports","Mathematics","Physics"], answer:"Communication"}
],
"Networks":[
{q:"Network connects?", options:["Computers","People","Books","Animals"], answer:"Computers"},
{q:"Purpose?", options:["Share data","Cook","Sleep","Run"], answer:"Share data"}
],
"Cybersecurity":[
{q:"Cybersecurity protects?", options:["Computers & networks","Plants","Animals","Buildings"], answer:"Computers & networks"},
{q:"Threat example?", options:["Hacking","Cooking","Running","Painting"], answer:"Hacking"}
]
};


// WORKSHEET BANK
const wsBank = {
"Grammar":["1. Write 5 nouns.","2. Write 5 verbs.","3. Identify parts of speech.","4. Form 5 adverbs.","5. Write 3 complex sentences."],
"Formal Letter":["1. Write a formal letter to principal.","2. Draft letter to bank manager.","3. Compose letter to editor.","4. Draft complaint letter.","5. Write letter to teacher."],
"Speech":["1. Write a 2-minute speech on pollution.","2. Speech on importance of education.","3. Speech on health and hygiene.","4. Speech on computer usage.","5. Speech on favorite hobby."],
"Prose":["1. Read passage & answer questions.","2. Summarize paragraph.","3. Identify main idea.","4. Write continuation.","5. Identify characters."],
"Algebra":["1. Solve 5x + 3 = 18","2. Factor x^2 + 7x + 12","3. Simplify 4x + 9x","4. Solve 3x - 8 = 10","5. Form expression for sum of 2 numbers."],
"Linear Equations":["1. Solve 2x + 5 = 15","2. Solve 3x - y = 6","3. Draw line y = x + 2","4. Solve 4x + 3y = 12","5. Apply elimination method."],
"Mensuration":["1. Area of rectangle 5x7 cm","2. Perimeter of square 6 cm","3. Volume of cube 4 cm","4. Surface area of cylinder r=3,h=7","5. Circumference of circle r=5cm"],
"Reproduction in Animals":["1. Draw human reproductive system","2. Explain fertilization","3. Define binary fission","4. Define budding","5. List types of reproduction"],
"Sound":["1. Draw wave diagram","2. Define frequency","3. Define amplitude","4. Explain echo","5. Speed of sound in water"],
"Electricity":["1. Draw simple circuit","2. Ohmâ€™s law calculation","3. Identify series circuit","4. Identify parallel circuit","5. Name safety devices"],
"1857 Revolt":["1. List causes","2. Name key leaders","3. Write main events","4. Outcome of revolt","5. Lessons learned"],
"Resources":["1. List renewable resources","2. List non-renewable resources","3. Explain conservation","4. Importance of water conservation","5. Forest conservation examples"],
"Judiciary":["1. Write role of Supreme Court","2. High Court duties","3. Lower court examples","4. Judge responsibilities","5. Importance of independent judiciary"],
"Vyakaran":["1. Examples of Sandhi","2. Examples of Samas","3. Correct gender usage","4. Singular/dual/plural examples","5. Correct tense sentences"],
"Patra Lekhan":["1. Write formal letter to principal","2. Write informal letter to friend","3. Include sender & receiver","4. Use proper salutation","5. End with signature"],
"HTML":["1. Create simple HTML page","2. Add headings & paragraphs","3. Insert image","4. Add hyperlink","5. Create list items"],
"AI Basics":["1. List types of AI","2. Example of narrow AI","3. Example of general AI","4. AI application in healthcare","5. AI in education"],
"Shabd Roop":["1. Write singular/plural forms","2. Change gender of words","3. Correct case","4. Form words for verbs","5. Use in sentences"],
"Dhatu Roop":["1. Write root verb forms","2. Present tense","3. Past tense","4. Future tense","5. Make sentences using verb"],
"French Grammar":["1. Write 5 nouns","2. Write 5 adjectives","3. Conjugate 3 verbs","4. Form simple sentences","5. Translate sentences"],
"Culture":["1. List French festivals","2. Describe French food","3. Famous French musicians","4. Social etiquette","5. Daily life in France"],
"Networks":["1. Draw simple network diagram","2. Explain types of networks","3. Define LAN & WAN","4. Identify network devices","5. Network examples"],
"Cybersecurity":["1. List common cyber threats","2. Define firewall","3. Explain antivirus software","4. Safety tips online","5. Case study of hacking"]
};


// LOGIN
function onLogin(guest=false){
  const msgEl = document.getElementById('loginMessage');
  msgEl.textContent = '';
  if(!guest){
    const role = document.getElementById('roleSelect').value;
    if(!role){ msgEl.textContent = 'Select role'; return; }
    userName = role + ' User'; userRole = role;
  }
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('appPage').style.display = 'flex';
  document.getElementById('welcomeUser').textContent = userName;
  loadSubjects();
  showToast('Welcome ' + userName, 'success');
}

// NAVIGATION
function navigate(e){
  document.querySelectorAll('.nav-btn').forEach(btn=>btn.classList.remove('active'));
  e.currentTarget.classList.add('active');
  const pageId = e.currentTarget.dataset.page;
  document.querySelectorAll('.page').forEach(page=>page.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
  
  if(pageId === 'subjectsPage') loadSubjects();
  if(pageId === 'topicPage' && selectedSubject) renderTopics();
  if(pageId === 'mindmapPage') updateFlowchartTopics();
  if(pageId === 'quizPage') loadQuiz();
  if(pageId === 'wsPage') loadWorksheet();
}

// SUBJECTS
function loadSubjects(){
  const quick = document.getElementById('subjectsQuick');
  const list = document.getElementById('subjectsList');
  quick.innerHTML = ''; list.innerHTML = '';
  subjects.forEach(subject => {
    const btnQuick = document.createElement('button');
    btnQuick.className = 'subject-card';
    btnQuick.textContent = subject;
    btnQuick.onclick = () => selectSubject(subject);
    quick.appendChild(btnQuick);
    
    const btnList = document.createElement('button');
    btnList.className = 'subject-card';
    btnList.textContent = subject;
    btnList.onclick = () => selectSubject(subject);
    list.appendChild(btnList);
  });
}

function selectSubject(subject){
  selectedSubject = subject;
  chosenTopic = subjectTopics[subject][0];
  navigate({currentTarget: {dataset: {page: 'topicPage'}}});
  updateFlowchartTopics();
}

function renderTopics(){
  const container = document.getElementById('topicsList');
  container.innerHTML = '';
  if(!selectedSubject) return;
  subjectTopics[selectedSubject].forEach(topic => {
    const btn = document.createElement('button');
    btn.className = 'subject-card';
    btn.textContent = topic;
    btn.onclick = () => {
      chosenTopic = topic;
      showToast(`Selected: ${topic}`, 'success');
      updateFlowchartTopics();
    };
    container.appendChild(btn);
  });
}

// FLOWCHART - FULLY WORKING
function updateFlowchartTopics(){
  const select = document.getElementById('flowTopicSelect');
  if(!selectedSubject){
    select.innerHTML = '<option value="">Choose subject first</option>';
    return;
  }
  const topics = subjectTopics[selectedSubject];
  select.innerHTML = '<option value="">Select topic...</option>' + 
    topics.map(t => `<option value="${t}">${t}</option>`).join('');
}

function generateFlowchart(){
  const topic = document.getElementById('flowTopicSelect').value;
  const statusEl = document.getElementById('flowchartStatus');
  const svg = document.getElementById('flowSvg');
  
  if(!topic){
    statusEl.textContent = 'âš ï¸ Please select a topic first';
    showToast('Select a topic first!', 'error');
    return;
  }
  
  if(!flowchartData[topic]){
    statusEl.textContent = `âŒ No flowchart for "${topic}"`;
    showToast('No flowchart data available', 'error');
    return;
  }
  
  // CLEAR SVG
  svg.innerHTML = '';
  
  const data = flowchartData[topic];
  const width = 900, height = 500;
  svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
  
  const statusEl = document.getElementById('flowchartStatus');
  statusEl.textContent = `ðŸŽ¨ Flowchart generated for "${topic}" (${data.length} steps)`;
  
  // CREATE NODES & LINES
  const nodeWidth = 180, nodeHeight = 60;
  const startY = 60;
  const vGap = 85;
  
  data.forEach((text, i) => {
    const x = (width - nodeWidth) / 2;
    const y = startY + i * vGap;
    
    // NODE
    const node = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    node.setAttribute('x', x);
    node.setAttribute('y', y);
    node.setAttribute('width', nodeWidth);
    node.setAttribute('height', nodeHeight);
    node.setAttribute('rx', '12');
    node.setAttribute('ry', '12');
    node.setAttribute('class', 'flow-node');
    svg.appendChild(node);
    
    // TEXT
    const txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    txt.setAttribute('x', x + nodeWidth/2);
    txt.setAttribute('y', y + nodeHeight/2 + 6);
    txt.setAttribute('class', 'flow-text');
    txt.textContent = text;
    svg.appendChild(txt);
    
    // LINE TO NEXT
    if(i < data.length - 1){
      const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      line.setAttribute('x1', x + nodeWidth/2);
      line.setAttribute('y1', y + nodeHeight);
      line.setAttribute('x2', x + nodeWidth/2);
      line.setAttribute('y2', y + nodeHeight + vGap - 45);
      line.setAttribute('class', 'flow-line');
      svg.appendChild(line);
    }
  });
  
  showToast(`Beautiful flowchart for ${topic}! âœ¨`, 'success');
}

// QUIZ & WORKSHEET (unchanged - working)
function loadQuiz(){
  const statusEl = document.getElementById('quizStatus');
  const outputEl = document.getElementById('quizOutput');
  if(!chosenTopic){ statusEl.textContent = 'Select topic first'; return; }
  statusEl.textContent = `Quiz for "${chosenTopic}"`;
  const q = quizBank[chosenTopic][0];
  outputEl.innerHTML = `
    <div style="padding:20px;background:rgba(255,255,255,0.05);border-radius:12px;">
      <p style="font-weight:600;color:var(--light-blue);">${q.q}</p>
      ${q.options.map(opt => `<button class="quiz-btn" onclick="checkAnswer(0,'${opt.replace(/'/g, "\\'")}',this)">${opt}</button>`).join('')}
    </div>`;
}

function checkAnswer(idx, opt, btn){
  const correct = quizBank[chosenTopic][0].answer;
  if(opt === correct){
    btn.classList.add('correct'); btn.innerHTML += ' âœ…';
    showToast('Correct!', 'success');
  } else {
    btn.classList.add('wrong'); btn.innerHTML += ' âŒ';
    showToast('Correct: ' + correct, 'error');
  }
  btn.style.pointerEvents = 'none';
}

function loadWorksheet(){
  const statusEl = document.getElementById('wsStatus');
  const outputEl = document.getElementById('wsOutput');
  if(!chosenTopic){ statusEl.textContent = 'Select topic first'; return; }
  statusEl.textContent = `Worksheet for "${chosenTopic}"`;
  const tasks = wsBank[chosenTopic];
  outputEl.innerHTML = tasks.map(t => `<li style="margin:15px 0;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;border-left:4px solid var(--light-purple);">${t}</li>`).join('');
}

function sendMessage(){ showToast('AI Chat ready!', 'success'); }
function showToast(msg, type='success'){
  const toast = document.createElement('div');
  toast.className = `toast ${type}`; toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 2500);
}
</script>
</body>
</html>
